<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <title>AR Card</title>
    <style>
      html,body{margin:0;overflow:hidden;}
      .ui{
        position: fixed; inset: 12px auto auto 12px; display:flex; gap:8px; z-index:9999;
      }
      .ui-right{
        position: fixed; inset: 12px 12px auto auto; display:flex; gap:8px; z-index:9999;
      }
      button{
        font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif;
        padding:10px 12px; border-radius:12px; border:1px solid #0003; background:#fff9; backdrop-filter: blur(6px);
      }
    </style>
  </head>
  <body>
    <!-- â–¼ URLã‚¯ã‚¨ãƒªã‹ã‚‰ facing ã‚’å–å¾—ï¼ˆ?facing=user ã§å†…ã‚«ãƒ¡ï¼‰ -->
    <script>
      const params = new URLSearchParams(location.search);
      const facing = (params.get('facing') || 'environment'); // 'environment' or 'user'
    </script>

    <!-- detectionModeç­‰ã«åŠ ãˆã€sourceType/webcam ã¨ facingMode ã‚’æŒ‡å®š -->
    <a-scene
      id="scene"
      embedded
      screenshot
      arjs="debugUIEnabled:false; sourceType: webcam; detectionMode: mono; patternRatio: 0.9; maxDetectionRate: 30"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; preserveDrawingBuffer: true;">
      
      <a-assets>
        <a-asset-item id="m" src="./assets/ism.glb"></a-asset-item>
      </a-assets>

      <!-- ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã§æºã‚Œè»½æ¸› -->
      <a-marker
        id="marker"
        type="pattern"
        url="./assets/myqr.patt"
        smooth="true"
        smoothCount="5"
        smoothTolerance="0.01"
        smoothThreshold="5">
        
        <a-entity id="model"
          gltf-model="#m"
          rotation="-25 0 0"
          scale="0.7 0.7 0.7"
          position="0 0.5 0">
        </a-entity>
      </a-marker>

      <a-entity camera="near:0.01; far:20000"></a-entity>
    </a-scene>

    <!-- å·¦ä¸Šï¼šå†™çœŸæ’®å½± / å³ä¸Šï¼šã‚«ãƒ¡ãƒ©åˆ‡æ›¿ -->
    <div class="ui">
      <button id="shotBtn">ğŸ“¸ å†™çœŸã‚’ä¿å­˜</button>
    </div>
    <div class="ui-right">
      <button id="switchBtn">ğŸ” ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
    </div>

    <script>
      // ----- AR.js ã« facingMode ã‚’åæ˜ ï¼ˆåˆæœŸåŒ–å‰ã«å±æ€§ã¸åŸ‹ã‚è¾¼ã‚€ï¼‰ -----
      // arjs ã® DOM å±æ€§ã‚’æ›´æ–°ï¼ˆfacingMode ã¯ ar.js å´ã® getUserMedia ã«æ¸¡ã•ã‚Œã‚‹ï¼‰
      const scene = document.querySelector('#scene');
      const orig = scene.getAttribute('arjs');
      scene.setAttribute('arjs', orig + `; facingMode: ${facing}`);

      // ----- marker ç¬æ–­ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆãã®ã¾ã¾æµç”¨ï¼‰ -----
      (function(){
        const marker = document.querySelector('#marker');
        const model  = document.querySelector('#model');
        let lostTimer = null;

        marker.addEventListener('markerFound', () => {
          if (lostTimer) { clearTimeout(lostTimer); lostTimer = null; }
          if (model) model.setAttribute('visible', true);
        });
        marker.addEventListener('markerLost', () => {
          lostTimer = setTimeout(() => {
            if (model) model.setAttribute('visible', false);
          }, 200);
        });
      })();

      // ----- å†™çœŸæ’®å½±ï¼šA-Frame screenshot ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -----
      // preserveDrawingBuffer:true ã«ã—ã¦ã‚ã‚‹ã®ã§ toDataURL ãŒä½¿ãˆã‚‹
      document.getElementById('shotBtn').addEventListener('click', () => {
        const sc = scene.components.screenshot;
        // 'perspective' ã§é€šå¸¸è¦–ç‚¹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã«é€£å‹•ï¼‰
        const canvas = sc.getCanvas('perspective');
        if (!canvas) return;
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        a.download = `ar-shot-${ts}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // ----- ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ï¼šURLã‚¯ã‚¨ãƒªã‚’ãƒˆã‚°ãƒ«ã—ã¦å†èª­ã¿è¾¼ã¿ï¼ˆå®‰å®šãƒ»ç°¡å˜ï¼‰ -----
      document.getElementById('switchBtn').addEventListener('click', () => {
        const next = (facing === 'environment') ? 'user' : 'environment';
        const p = new URLSearchParams(location.search);
        p.set('facing', next);
        location.search = '?' + p.toString(); // ãƒšãƒ¼ã‚¸ã‚’å†åˆæœŸåŒ–â†’AR.jsãŒæ–°ã—ã„ facingMode ã§èµ·å‹•
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <title>AR Card</title>
    <style>html,body{margin:0;overflow:hidden;}</style>
  </head>
  <body>
    <!-- detectionMode: mono（一般的な白黒パターン検出）
         patternRatio: 0.9 前後（黒枠の太さに合わせて。0.75〜0.95で微調整）
         maxDetectionRate: 30 で負荷を抑えつつ安定化 -->
    <a-scene
      embedded
      arjs="debugUIEnabled:false; detectionMode: mono; patternRatio: 0.9; maxDetectionRate: 30"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;">
      
      <a-assets>
        <a-asset-item id="m" src="./assets/ism.glb"></a-asset-item>
      </a-assets>

      <!-- スムージングで揺れ軽減 -->
      <!-- smoothCount: 連続フレームの平均化数（3〜10で調整）
           smoothTolerance: 許容誤差（0.01〜0.05）
           smoothThreshold: 平滑化を発動する最小フレーム数 -->
      <a-marker
        type="pattern"
        url="./assets/myqr.patt"
        smooth="true"
        smoothCount="5"
        smoothTolerance="0.01"
        smoothThreshold="5">
        
        <a-entity id="model"
          gltf-model="#m"
          rotation="0 0 0"
          scale="1 1 1"
          position="0 0.5 0">
        </a-entity>
      </a-marker>

      <!-- クリッピングで消えるのを防ぐ（必要なら） -->
      <a-entity camera="near:0.01; far:20000"></a-entity>
    </a-scene>

    <!-- 瞬断で消えないように、markerLost を少し遅らせて反映 -->
    <script>
      (function(){
        const marker = document.querySelector('a-marker');
        const model  = document.querySelector('#model');
        let lostTimer = null;

        marker.addEventListener('markerFound', () => {
          if (lostTimer) { clearTimeout(lostTimer); lostTimer = null; }
          if (model) model.setAttribute('visible', true);
        });

        marker.addEventListener('markerLost', () => {
          // 150〜300ms 程度の猶予。ブレが多ければ数値を上げる
          lostTimer = setTimeout(() => {
            if (model) model.setAttribute('visible', false);
          }, 200);
        });
      })();
    </script>
  </body>
</html>

